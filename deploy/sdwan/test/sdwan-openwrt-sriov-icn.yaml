---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sdwan-config-sriov-icn
data:
  entrypoint.sh: |
    #!/bin/bash
    # Always exit on errors.
    set -e
   
    interface=net1
    ipaddr=`ifconfig net1 | awk '/inet/{print $2}' | cut -f2 -d ":" | awk 'NR==1 {print $1}'`
    
    net_config=/etc/config/network
    cat >> $net_config << EOF
    config interface 'wan'
        option ifname '$interface'
        option proto 'static'
        option ipaddr '$ipaddr'
        option netmask '255.255.255.0'
    EOF

    /sbin/procd &
    /sbin/ubusd &
    sleep 1
    /etc/init.d/rpcd start
    /etc/init.d/dnsmasq start
    /etc/init.d/network start
    /etc/init.d/odhcpd start
    /etc/init.d/uhttpd start
    /etc/init.d/log start
    /etc/init.d/dropbear start
    /etc/init.d/mwan3 restart

    echo "Entering sleep... (success)"

    # Sleep forever.
    while true; do sleep 100; done 

---
apiVersion: v1
kind: Pod
metadata:
  name: sdwan-sriov-icn
  annotations:
    k8s.v1.cni.cncf.io/networks: sriov-eno2
spec:
  containers:
  - name: sdwan-pod2
    image: hle2/openwrt-1806-mwan3:v0.1.0
    command:
    - /bin/sh
    - /init/entrypoint.sh
    imagePullPolicy: IfNotPresent
    resources:
      requests:
        intel.com/intel_sriov_700: '1'
      limits:
        intel.com/intel_sriov_700: '1'
    securityContext:
      privileged: true
    volumeMounts:
      - name: entrypoint-sh
        mountPath: /init
  volumes:
    - name: entrypoint-sh
      configMap:
        name: sdwan-config-sriov-icn
        items:
        - key: entrypoint.sh
          path: entrypoint.sh
